<html>
<head>
<title>show cache</title>
<style>
body,table,td,input {
	font-family: 'lucida grande', tahoma, verdana, arial, sans-serif;
	font-size: 14px;
}
.cachelist {
	border: solid 1px #777;
	margin: 3px 0px 8px 0px;
	border-spacing:0;
	border-collapse:collapse;
}
.cachelist td {
	padding: 2px 7px;
}
.cachelist thead {
	background: #bff;
}
.s_compiling {
	background: #f33;
}
.s_loaded {
	background: #3f3;
}
.s_unloaded {
	background: #000;
	color: #fff;
}
</style>
</head>
<%$
//returns miliseconds
double dateDiff(timespec t1, timespec t2) {
	return double(t2.tv_sec-t1.tv_sec)*1000+double(t2.tv_nsec-t1.tv_nsec)/1000000;
}
%>
<body>
	<%
	cppspManager* cm=server->manager();
	if(cm==NULL) throw runtime_error("server is not managed by cppspManager");
	%>
	Dynamic page cache: <br />
	<table class="cachelist">
		<thead>
			<tr>
				<td>Path</td>
				<td>Load time</td>
				<td>Last access</td>
				<td>State</td>
			</tr>
		</thead>
		<%
		for(auto it=cm->cache.begin();it!=cm->cache.end();it++) {
			auto tmp=(*it).second;
			char buffer[256];
			tm time1; localtime_r(&tmp->lastLoad.tv_sec,&time1);
			strftime(buffer, sizeof(buffer), "%F %r", &time1);
			const char* state=tmp->compiling?"compiling":tmp->loaded?"loaded":"unloaded";
			%>
			<tr>
				<td><%htmlEscape((*it).first,output);%></td>
				<td><%htmlEscape(buffer,output);%></td>
				<td><%=int64_t(-dateDiff(cm->curTime,tmp->lastCheck)/1000)%> seconds ago</td>
				<td class="s_<%=state%>"><%=state%></td>
			</tr>
			<%
		}
		%>
	</table>
	Static page cache: <br />
	<table class="cachelist">
		<thead>
			<tr>
				<td>Path</td>
				<td>Load time</td>
				<td>Last access</td>
			</tr>
		</thead>
		<%
		for(auto it=cm->staticCache.begin();it!=cm->staticCache.end();it++) {
			auto tmp=(*it).second;
			char buffer[256];
			tm time1; localtime_r(&(*it).second->lastLoad.tv_sec,&time1);
			strftime(buffer, sizeof(buffer), "%F %r", &time1);
			%>
			<tr>
				<td><%htmlEscape((*it).first,output);%></td>
				<td><%htmlEscape(buffer,output);%></td>
				<td><%=int64_t(-dateDiff(cm->curTime,tmp->lastCheck)/1000)%> seconds ago</td>
			</tr>
			<%
		}
		%>
	</table>
	Route cache: <br />
	<table class="cachelist">
		<thead>
			<tr>
				<td>Path</td>
				<td>Handler</td>
				<td>Last update</td>
			</tr>
		</thead>
		<%
		for(auto it=server->routeCache.begin();it!=server->routeCache.end();it++) {
			auto tmp=(*it).second;
			%>
			<tr>
				<td><%htmlEscape((*it).first,output);%></td>
				<td><%output.writeF("%p, %p",tmp->handler.func,tmp->handler.data);%></td>
				<td><%=int64_t(-dateDiff(cm->curTime,tmp->lastUpdate)/1000)%> seconds ago</td>
			</tr>
			<%
		}
		%>
	</table>
</body>
</html>

